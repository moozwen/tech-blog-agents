# 実装指示書

## 背景および実現したいこと

本プロジェクトは、技術ブログ記事の執筆を支援するために、複数のAIエージェントを組み合わせたPythonアプリケーションを開発するものです。  
ユーザーは、以下のプロセスでブログ記事を作成できます。

1. ユーザーが記事にしたい内容を「断片」（キーワード、箇条書き、メモなど）として入力
2. ドラフト生成エージェントが断片をもとに約1000文字の初稿ドラフトを作成
3. 複数の推敲エージェント（スタイル調整、文法チェック、技術的正確性、SEO最適化など）がドラフトを改善
4. 改善済みドラフトをユーザーに提示
5. ユーザーがフィードバック（要望）を出し、要望反映エージェントがドラフトを修正
6. 再度推敲エージェントが修正後ドラフトをブラッシュアップ
7. ユーザーの「完了」指示まで、5-6のプロセスを繰り返す

このフローは、LangGraphを用いてエージェント間のやり取りやプロンプト管理を行うことで、柔軟な拡張性と管理性を確保します。

## LangGraphを用いた実装概要

- **LangGraph**: 複数の言語モデルやエージェントをGraph構造で定義し、入出力フローを制御するためのフレームワーク
- グラフ内に以下のノードを設ける想定
  - 「ドラフト生成エージェント」ノード
  - 「推敲エージェント」ノード群（スタイル、技術的正確性、SEO、文法）
  - 「要望反映エージェント」ノード
- コントローラー層（Pythonロジック）で、ユーザー入力や完了指示を受け取り、LangGraph上のノードにデータを流す

## ディレクトリ構成（例）

```
project-root/
├─ README.md
├─ requirements.txt
├─ src/
│  ├─ main.py            # アプリケーションエントリポイント（コントローラ的役割）
│  ├─ config/
│  │  ├─ settings.py     # 設定ファイル(LangGraph用モデル設定、APIキー、パラメータ)
│  │  └─ prompts/        # プロンプトテンプレート保管場所
│  │     ├─ draft_prompt.txt
│  │     ├─ revision_prompt.txt
│  │     ├─ style_prompt.txt
│  │     ├─ technical_prompt.txt
│  │     ├─ seo_prompt.txt
│  │     └─ grammar_prompt.txt
│  ├─ agents/
│  │  ├─ base_agent.py   # 基底クラス（LangGraph用の共通ロジックをまとめる）
│  │  ├─ draft_agent.py  # ドラフト生成エージェント実装
│  │  ├─ style_agent.py  # スタイル調整エージェント
│  │  ├─ tech_agent.py   # 技術的正確性エージェント
│  │  ├─ seo_agent.py    # SEOエージェント
│  │  ├─ grammar_agent.py# 文法・校正エージェント
│  │  ├─ revision_agent.py # 要望反映エージェント
│  │  └─ init.py
│  ├─ graph/
│  │  ├─ blog_graph.py   # LangGraphでのグラフ定義（各ノードエージェント間の接続）
│  │  └─ init.py
│  ├─ utils/
│  │  ├─ text_processing.py # テキスト統合、差分表示などユーティリティ関数
│  │  └─ logger.py         # ロギング機能
│  └─ init.py
└─ tests/
├─ test_agents.py
├─ test_flow.py
└─ init.py
```

## Pythonモジュール情報

- `src/config/settings.py`  
  - APIキー、モデル選択、トークン上限、LangGraph用の設定（Graph構築時のパラメータ）などを定義。
  
- `src/config/prompts/*.txt`  
  - 各エージェントが使用するプロンプトテンプレートをテキストファイルで管理。  
  - 例：`draft_prompt.txt`にはドラフト生成エージェントが使用するベースプロンプトを記述。

- `src/agents/base_agent.py`  
  - LangGraphエージェント用の抽象クラス。  
  - 各エージェントはこれを継承し、`run()`メソッドで入出力処理を実装。

- `src/agents/draft_agent.py`  
  - 断片（ユーザー提供）の入力を受け取り、1000文字程度の初期ドラフトを生成。

- `src/agents/style_agent.py`  
  - ドラフトを受け取り、可読性・スタイルを改善したテキストを出力。

- `src/agents/tech_agent.py`  
  - 技術的正確性をチェックし、必要な補足や修正を行う。

- `src/agents/seo_agent.py`  
  - SEO観点からキーワード最適化やメタデータ提案を行う。

- `src/agents/grammar_agent.py`  
  - 文法チェック、スペルミス修正、スタイルガイド準拠確認を行う。

- `src/agents/revision_agent.py`  
  - ユーザーが指定した要望を元に、前段階のドラフトを修正する。

- `src/graph/blog_graph.py`  
  - LangGraphを用いて、上記エージェントをノードとして定義。  
  - 最初は`draft_agent`ノードから開始し、次に`style_agent`、`grammar_agent`、`tech_agent`、`seo_agent`と順次渡すフローや、要望があれば`revision_agent`ノードへの経路を準備。  
  - ユーザーの「完了」指示までループ可能な構造。

## 各エージェントの基本的な実装情報

### ドラフト生成エージェント (Drafting Agent)

- **入力**: ユーザーの「断片」（文字列リストやJSON）  
- **プロンプト例**: `draft_prompt.txt`  
  - テンプレート中に`{fragments}`変数を用意し、ユーザー断片を埋め込む  
  - 「1000文字程度」、「技術ブログ」、「指定テーマ」などの条件明記
- **出力**: 初期ドラフトテキスト（ストリング）

### スタイルエージェント (Style Agent)

- **入力**: ドラフトテキスト  
- **プロンプト例**: `style_prompt.txt`  
  - 「読者が読みやすく、簡潔で明瞭な文章に改善せよ」などの指示
- **出力**: 改善済みテキスト

### 技術的正確性エージェント (Technical Accuracy Agent)

- **入力**: テキスト  
- **プロンプト例**: `technical_prompt.txt`  
  - 「技術的に正しい内容に修正。誤解を与えかねない表現を明確化」など
- **出力**: 技術的に整合性の取れたテキスト

### SEOエージェント (SEO Agent)

- **入力**: テキスト  
- **プロンプト例**: `seo_prompt.txt`  
  - 「適切なキーワードを自然に挿入し、記事タイトルや見出しをSEO的に最適化」
- **出力**: SEO最適化済みテキスト

### 文法エージェント (Grammar Agent)

- **入力**: テキスト  
- **プロンプト例**: `grammar_prompt.txt`  
  - 「文法的ミス、誤字脱字を修正し、統一感のある表記に直せ」
- **出力**: 文法校正済みテキスト

### 要望反映エージェント (Revision Agent)

- **入力**: テキスト、ユーザー要望（JSONなどで表現）  
- **プロンプト例**: `revision_prompt.txt`  
  - 「ユーザー要望に従って本文を修正せよ」  
  - 要望は箇条書きでプロンプトに挿入
- **出力**: 修正後テキスト

## その他考慮事項

- **ログ出力**:  
  - `src/utils/logger.py`で各処理ステップ、入出力、エラー情報をロギング。  
  - 開発段階ではデバッグログを詳細に出し、本番運用時にはログレベルを下げる。

- **バージョン管理**:  
  - ドラフトや修正履歴を記録し、ユーザーが過去バージョンに戻れるようにする。

- **テスト**:  
  - `tests`ディレクトリで基本的なユニットテストを行い、  
  - `test_agents.py`で各エージェントの最小動作確認、  
  - `test_flow.py`で全体の流れを統合テスト。

- **拡張性**:  
  - 新たなエージェントを追加したい場合は`agents`ディレクトリにモジュールを追加し、`blog_graph.py`でグラフにノードを組み込むだけで対応可能。

以上
